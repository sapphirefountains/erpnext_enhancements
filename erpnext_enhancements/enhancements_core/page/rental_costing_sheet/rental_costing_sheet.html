<div id="rental-costing-app" class="rental-sheet-container" v-cloak>
    <!-- Header Controls -->
    <div class="sheet-header flex justify-between align-center">
        <div class="flex" style="gap: 15px;">
            <div class="control-input">
                <label>Project Name</label>
                <input type="text" class="form-control input-sm" v-model="state.project_name" placeholder="e.g. Sapphire Fountain Event">
            </div>
            <div class="control-input">
                <label>Customer</label>
                <input type="text" class="form-control input-sm" v-model="state.customer" placeholder="Customer Name">
            </div>
        </div>
        <div class="actions">
            <button class="btn btn-default btn-sm" @click="clear_sheet">Clear</button>
            <button class="btn btn-default btn-sm" @click="export_csv">Export CSV</button>
            <button class="btn btn-primary btn-sm" @click="save_local">Save Draft</button>
        </div>
    </div>

    <!-- Summary Box -->
    <div class="summary-box">
        <div class="summary-item">
            <span class="label">Total Cost</span>
            <span class="value">{{ format_currency(grand_total_cost) }}</span>
        </div>
        <div class="summary-item">
            <span class="label">Total Markup</span>
            <span class="value text-success">{{ format_currency(total_markup_value) }}</span>
        </div>
        <div class="summary-item highlight">
            <span class="label">Grand Total Price</span>
            <span class="value">{{ format_currency(grand_total_price) }}</span>
        </div>
    </div>

    <!-- Sections Loop -->
    <div v-for="(section, s_idx) in state.sections" :key="s_idx" class="section-block">
        <h4 class="section-title">{{ section.title }}</h4>
        
        <div class="table-responsive">
            <table class="table table-bordered table-condensed costing-table">
                <thead>
                    <tr>
                        <th style="width: 150px;">Job Expense</th>
                        <th style="width: 120px;">Vendor</th>
                        <th style="min-width: 150px;">Description</th>
                        <th style="width: 60px;">Qty</th>
                        <th style="width: 70px;">Unit</th>
                        <th style="width: 100px;">Quote (Cost)</th>
                        <th style="width: 100px; background-color: #f7fafc;">Total Cost</th>
                        <th style="width: 70px;">Mkup %</th>
                        <th style="width: 90px; background-color: #f7fafc;">Mkup/Unit</th>
                        <th style="width: 100px; background-color: #f7fafc;">Unit Price</th>
                        <th style="width: 110px; background-color: #e6fffa; font-weight: bold;">Sub-Total</th>
                        <th style="width: 150px;">Notes</th>
                        <th style="width: 40px;"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(item, i_idx) in section.items" :key="i_idx">
                        <td><input type="text" class="form-control input-xs" v-model="item.job_expense"></td>
                        <td><input type="text" class="form-control input-xs" v-model="item.vendor"></td>
                        <td><input type="text" class="form-control input-xs" v-model="item.description"></td>
                        <td><input type="number" class="form-control input-xs text-right" v-model.number="item.qty"></td>
                        <td>
                            <select class="form-control input-xs" v-model="item.unit">
                                <option value="Nos">Nos</option>
                                <option value="hr">hr</option>
                                <option value="day">day</option>
                                <option value="trip">trip</option>
                                <option value="lot">lot</option>
                            </select>
                        </td>
                        <td><input type="number" step="0.01" class="form-control input-xs text-right" v-model.number="item.quote"></td>
                        
                        <!-- Calculated Columns -->
                        <td class="text-right bg-gray">{{ format_currency(item.qty * item.quote) }}</td>
                        <td><input type="number" step="0.1" class="form-control input-xs text-right" v-model.number="item.markup_percent"></td>
                        <td class="text-right bg-gray">{{ format_currency(calculate_markup_per_unit(item)) }}</td>
                        <td class="text-right bg-gray">{{ format_currency(calculate_unit_total(item)) }}</td>
                        <td class="text-right bg-success-light">{{ format_currency(calculate_sub_total(item)) }}</td>
                        
                        <td><input type="text" class="form-control input-xs" v-model="item.notes"></td>
                        <td class="text-center">
                            <button class="btn btn-xs btn-danger" @click="remove_row(s_idx, i_idx)">&times;</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <button class="btn btn-xs btn-default" @click="add_row(s_idx)">+ Add Row</button>
    </div>

    <!-- Overall Footer Totals (Optional Redundancy) -->
    <div class="row" style="margin-top: 30px; border-top: 2px solid #ddd; padding-top: 15px;">
        <div class="col-md-8 text-right"><strong>Grand Totals:</strong></div>
        <div class="col-md-4">
            <table class="table table-bordered">
                <tr>
                    <td>Total Cost</td>
                    <td class="text-right">{{ format_currency(grand_total_cost) }}</td>
                </tr>
                <tr>
                    <td>Total Price (Client)</td>
                    <td class="text-right" style="font-weight: bold; font-size: 1.2em;">{{ format_currency(grand_total_price) }}</td>
                </tr>
            </table>
        </div>
    </div>
</div>
