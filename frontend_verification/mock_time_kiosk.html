<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Time Kiosk</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { padding: 20px; background-color: #f0f2f5; }
        .page-container { background: white; min-height: 80vh; }
    </style>
</head>
<body>

    <div id="frappe-app-wrapper" class="page-container"></div>

    <script>
        // MOCK FRAPPE OBJECT
        window.frappe = {
            pages: {},
            ui: {
                make_app_page: function(opts) {
                    const $wrapper = $(opts.parent);
                    const $main = $('<div class="page-main"></div>');
                    $wrapper.append($main);
                    return { main: $main[0] };
                },
                form: {
                    make_control: function(opts) {
                        console.log("Mock make_control", opts);
                        const $parent = opts.parent;
                        // Render a simple input for the Link field mock
                        const $input = $('<input type="text" class="form-control" data-fieldname="' + opts.df.fieldname + '" placeholder="' + opts.df.placeholder + '">');
                        $parent.append($input);

                        return {
                            df: opts.df,
                            get_value: () => $input.val(),
                            set_value: (val) => $input.val(val),
                            refresh: () => {}
                        };
                    }
                }
            },
            require: function(path) {},
            call: function(opts) {
                console.log("Mock frappe.call:", opts.method);

                // MOCK API RESPONSES
                if (opts.method === 'erpnext_enhancements.api.time_kiosk.get_current_status') {
                     setTimeout(() => {
                        if (window.mockStatus === 'Open') {
                             opts.callback({
                                message: {
                                    name: 'INTERVAL-123',
                                    project: 'PROJ-001',
                                    project_title: 'Website Redesign',
                                    description: 'Coding',
                                    start_time: new Date(new Date().getTime() - 3600000).toISOString(),
                                    employee: 'EMP-001'
                                }
                            });
                        } else {
                            // BUG REPRODUCTION: Return employee even when idle
                            opts.callback({ message: { employee: 'EMP-001' } });
                        }
                    }, 100);
                } else if (opts.method === 'erpnext_enhancements.api.time_kiosk.log_time') {
                     setTimeout(() => {
                        if (opts.args.action === 'Start') {
                            window.mockStatus = 'Open';
                            opts.callback({ message: { status: 'success', message: 'Clocked In Successfully' } });
                        } else {
                            window.mockStatus = 'Idle';
                             opts.callback({ message: { status: 'success', message: 'Clocked Out Successfully' } });
                        }
                    }, 200);
                }
            },
            msgprint: function(msg) { alert(msg); },
            show_alert: function(msg) { console.log("Alert:", msg); }
        };

        // Initial Mock State
        window.mockStatus = 'Idle';

    </script>

    <!-- Load the actual script -->
    <script src="../erpnext_enhancements/erpnext_enhancements/page/time_kiosk/time_kiosk.js"></script>

    <script>
        $(document).ready(function() {
            const wrapper = document.getElementById('frappe-app-wrapper');
            if (frappe.pages['time-kiosk']) {
                frappe.pages['time-kiosk'].on_page_load(wrapper);
            }
        });
    </script>
</body>
</html>
