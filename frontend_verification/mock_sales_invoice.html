<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Sales Invoice Verification</title>
</head>
<body>
    <div id="result">Waiting...</div>
    <div id="custom_comments_field_wrapper"></div>

    <script>
        // Mock frappe
        window.frappe = {
            ui: {
                form: {
                    on: function(doctype, events) {
                        console.log("Registered events for " + doctype);
                        window.registered_events = events;
                    }
                }
            }
        };

        // Mock erpnext_enhancements
        window.erpnext_enhancements = {
            render_comments_app: function(frm, fieldname) {
                console.log("render_comments_app called for " + fieldname);
                document.getElementById('result').innerText = "Success: render_comments_app called for " + fieldname;
                // Simulate rendering something
                if (frm.fields_dict[fieldname] && frm.fields_dict[fieldname].wrapper) {
                    frm.fields_dict[fieldname].wrapper.innerHTML = "<div>Comments App Rendered Here</div>";
                }
            }
        };

        // Mock Form Object
        const mock_frm = {
            doc: {
                __islocal: 0
            },
            fields_dict: {
                "custom_comments_field": {
                    wrapper: document.getElementById('custom_comments_field_wrapper')
                }
            },
            trigger: function(event_name) {
                if (window.registered_events && window.registered_events[event_name]) {
                    window.registered_events[event_name](this);
                } else {
                    console.log("Event not found or not a direct function: " + event_name);
                    // Handle the specific logic for 'render_comments_section' which is defined as a method on the events object
                    if (window.registered_events && window.registered_events[event_name]) {
                         window.registered_events[event_name](this);
                    }
                }
            }
        };

    </script>

    <!-- Load the script to be tested -->
    <script src="../erpnext_enhancements/public/js/sales_invoice_comments.js"></script>

    <script>
        // Test Logic
        // Simulate refresh
        if (window.registered_events && window.registered_events.refresh) {
            console.log("Triggering refresh...");
            window.registered_events.refresh(mock_frm);
        } else {
            document.getElementById('result').innerText = "Error: refresh event not registered";
        }
    </script>
</body>
</html>
